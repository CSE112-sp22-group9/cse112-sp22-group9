# This file was auto-generated by the Firebase CLI
# https://github.com/firebase/firebase-tools
name: Deploy to Testing site-Firebase Hosting on merge to testing
'on':
  push:
    # placeholder branch can be used instead of "testing" to check action runs
    branches:
      - testing
  workflow_dispatch:
jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - run: 'n'
      - uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: '${{ secrets.GITHUB_TOKEN }}'
          firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT_STEGOSOURCE_9LIVES }}'
          # projectId refers to the overall firebase project
          projectId: stegosource-9lives
          # the target is the particular deployment site
          target: testing-stegosource-9lives
          # channelId is the different preview links (or "live" for the currently deployed)
          # "testing-stegosource-9-lives" is  just a place holder to deploy to a temp link
          channelId: live
          
  run_testing:
      # "needs: identifies any jobs that must complete successfully before
      # we only want to run tests on latest deployment
      needs: build_and_deploy
      runs-on: ubuntu-latest
      steps:
          - name: Check out Git repository
            uses: actions/checkout@v2

          - name: Set up Node.js
            uses: actions/setup-node@v1
            with:
              node-version: 12

          - name: Pull origin testing
            run: |
              git pull origin ${{ github.ref }}

          - name: Install Node.js dependencies
            run: npm ci

          - name: Run Puppeteer tests
            # can we just do 'npm test source/tests/sampleP.test.js'
            run: npm test -c jest-puppeteer.config.js source/tests/PuppTests.test.js
